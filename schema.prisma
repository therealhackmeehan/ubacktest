datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  lastActiveTimestamp       DateTime        @default(now())
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  checkoutSessionId         String?
  subscriptionStatus        String?         // 'active', 'canceled', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'hobby', 'pro'
  sendNewsletter            Boolean         @default(false)
  datePaid                  DateTime?
  credits                   Int             @default(3)

  strategies                Strategy[]
  results                   Result[]

  sentShares                Share[]         @relation(name: "SenderShares")
  receivedShares            Share[]         @relation(name: "ReceiverShares")
}

model Strategy {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  code                      String?         // user pythonic code   

  results                   Result[]
  
  @@unique([userId, name]) // compound unique constraint       
}

model Result {
  id                        String        @id @default(uuid())
  createdAt                 DateTime      @default(now())

  user                      User          @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  code                      String

  public                    Boolean       @default(true)    

  fromStrategy              Strategy?     @relation(fields: [fromStrategyID], references: [id], onDelete: Cascade)   
  fromStrategyID            String? 

  length                    Int
  pl                        Float?
  plWCosts                  Float?
  cagr                      Float?
  numTrades                 Int
  numProfTrades             Int
  percTradesProf            Float?
  sharpeRatio               Float?
  sortinoRatio              Float?
  maxDrawdown               Float?
  maxGain                   Float?
  meanReturn                Float?
  stddevReturn              Float?
  maxReturn                 Float?
  minReturn                 Float?

  timestamp                 String[]
  open                      Float[]
  close                     Float[]
  high                      Float[]
  low                       Float[]
  volume                    Float[]
  signal                    Float[]
  returns                   Float[]
  sp                        Float[]
  portfolio                 Float[]
  portfolioWithCosts        Float[]
  cash                      Float[]
  equity                    Float[]
  cashWithCosts             Float[]
  equityWithCosts           Float[]
  userDefinedData           Json?
  
  formInputs                Json

  shares                    Share[]

  @@unique([userId, name])
}

model Share {
  id                        String        @id @default(uuid())
  sharedAt                  DateTime      @default(now())
  
  user                      User          @relation(name: "SenderShares", fields: [userID], references: [id])
  userID                    String

  receiver                  User          @relation(name: "ReceiverShares", fields: [receiverID], references: [id])
  receiverID                String

  result                    Result        @relation(fields: [resultID], references: [id], onDelete: Cascade)
  resultID                  String

  accepted                  Boolean       @default(false)

  @@unique([resultID, receiverID])
}

model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}